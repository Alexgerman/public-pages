<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <script type="text/javascript" src="http://underscorejs.ru/underscore-min.js"></script>

    <style>
        body:{
            background-color:#ffffff;
        }
    
        * {
            text-align: center;
        }

        #weather:after {
            content: "";
            display: table;
            clear: both;
        }

        .block {
            border: 1px solid #333333;
            float: left;
            width: 200px;
            margin: 5px;
        }

        .block img {
            height: 50px;
            width: 50px;
        }
    </style>
</head>
<body>

<div id="current"></div>

<div id="weather">
</div>

<script type="text/html" id="_weather_block">
    <div class="block">
        <h3>{{week_day}}, {{day}} {{month}}</h3>
        <img src="{{image}}"/>

        <p>{{conditions}}</p>

        <p>{{low}} - {{high}} °C</p>
    </div>
</script>

<script type="text/html" id="_weather_current">
    <h2>{{place}}</h2>
    <h3>current {{current}} °C</h3>
    <p><img src="{{image}}"></p>
    <h4>{{time}}</h4>
</script>

<script>
    _.templateSettings = {
        interpolate: /\{\{(.+?)\}\}/g
    };

    var getWeatherComplete = function(e) {
        var template = document.getElementById('_weather_block').innerHTML,
                weather = JSON.parse(e.target.responseText),
                simpleforecast = weather.forecast.simpleforecast.forecastday,
                block = '', row;

        for (var i = 0; i < 5; i++) {
            row = simpleforecast[i];
            block += _.template(template, {
                week_day: row.date.weekday_short,
                day: row.date.day,
                month: row.date.monthname,
                image: row.icon_url,
                conditions: row.conditions,
                low: row.low.celsius,
                high: row.high.celsius
            });
        }

        document.getElementById('weather').innerHTML = block;
    };

    var getCurrentComplete = function(e) {
        var template = document.getElementById('_weather_current').innerHTML,
                current = JSON.parse(e.target.responseText).current_observation;
        console.log(current);
        document.getElementById('current').innerHTML = _.template(template, {
            current: current.temp_c,
            time: current.local_time_rfc822,
            place: current.display_location.full,
            image: current.icon_url
        });
    }

    navigator.geolocation.getCurrentPosition(function(position) {
        var urlWeather = ['http://api.wunderground.com/api/5e45ee03793c7cd8/forecast10day/q/', position.coords.latitude, ',', position.coords.longitude, '.json'],
                xhr;
        xhr = new XMLHttpRequest();
        xhr.overrideMimeType("application/json");
        xhr.open("GET", urlWeather.join(''), true);
        xhr.onload = getWeatherComplete;
        xhr.send();

        var urlCurrent = ['http://api.wunderground.com/api/5e45ee03793c7cd8/conditions/q/', position.coords.latitude, ',', position.coords.longitude, '.json'],
                xhr3;
        xhr3 = new XMLHttpRequest();
        xhr3.overrideMimeType("application/json");
        xhr3.open("GET", urlCurrent.join(''), true);
        xhr3.onload = getCurrentComplete;
        xhr3.send();
    });
</script>

</body>
</html>
